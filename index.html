<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Pro Mini Flasher</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #1a1a2e; color: #fff; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #16213e; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 450px; text-align: center; border: 1px solid #0f3460; }
        h2 { color: #4ecca3; margin-bottom: 1.5rem; }
        .file-input { margin: 20px 0; background: #0f3460; padding: 15px; border-radius: 8px; border: 1px dashed #444; }
        button { background: #4ecca3; color: #1a1a2e; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { background: #45b293; }
        button:disabled { background: #555; cursor: not-allowed; color: #aaa; }
        #status-box { margin-top: 20px; background: #000; color: #00ff41; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.85rem; text-align: left; height: 150px; overflow-y: auto; border: 1px solid #333; }
        .error { color: #ff4d4d; }
    </style>
</head>
<body>

<div class="container">
    <h2>Pro Mini Flasher</h2>
    <p style="font-size: 0.9rem; color: #999;">Atmega328p - Web Serial API</p>
    
    <div class="file-input">
        <input type="file" id="hexFile" accept=".hex">
    </div>

    <button id="uploadBtn">CONECTAR Y FLASHEAR</button>

    <div id="status-box">
        <div>> Sistema listo.</div>
    </div>
</div>

<script type="module">
    // Usamos Skypack, que es mÃ¡s fiable para GitHub Pages y evita el error 404
    import Avrgirl from 'https://cdn.skypack.dev/avrgirl-arduino-next';

    const uploadBtn = document.getElementById('uploadBtn');
    const statusBox = document.getElementById('status-box');
    const fileInput = document.getElementById('hexFile');

    function log(msg, isError = false) {
        const div = document.createElement('div');
        if (isError) div.className = 'error';
        div.innerHTML = `> ${msg}`;
        statusBox.appendChild(div);
        statusBox.scrollTop = statusBox.scrollHeight;
    }

    // Verificar compatibilidad del navegador
    if (!("serial" in navigator)) {
        log("ERROR: Tu navegador no soporta Web Serial API.", true);
        log("Usa la versiÃ³n mÃ¡s reciente de Chrome o Edge.", true);
        uploadBtn.disabled = true;
    }

    uploadBtn.addEventListener('click', async () => {
        if (fileInput.files.length === 0) {
            alert("Selecciona un archivo .hex primero.");
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        log("Archivo cargado: " + file.name);

        reader.onload = async (event) => {
            const contents = event.target.result;
            
            // ConfiguraciÃ³n para Pro Mini
            const avrgirl = new Avrgirl({
                board: 'pro-mini',
                debug: true
            });

            try {
                uploadBtn.disabled = true;
                log("Solicitando acceso al puerto USB...");
                log("Selecciona tu adaptador FTDI en la lista.");

                // El flasheo inicia la peticiÃ³n del puerto
                avrgirl.flash(contents, (err) => {
                    if (err) {
                        log("ERROR: " + err.message, true);
                        console.error(err);
                    } else {
                        log("Â¡CARGA COMPLETADA CON Ã‰XITO! ðŸŽ‰");
                    }
                    uploadBtn.disabled = false;
                });

            } catch (error) {
                log("Error de sistema: " + error.message, true);
                uploadBtn.disabled = false;
            }
        };

        reader.readAsArrayBuffer(file);
    });
</script>

</body>
</html>
